<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Japanese Flashcards</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      transition: background 0.4s, color 0.4s;
    }
    :root {
      --bg: #f4f4f4;
      --text: #111;
      --card: white;
      --border: #ddd;
      --correct: #d4edda;
      --wrong: #f8d7da;
    }
    [data-theme="dark"] {
      --bg: #111;
      --text: #f4f4f4;
      --card: #1e1e1e;
      --border: #444;
      --correct: #2e5939;
      --wrong: #5b2c2c;
    }
    .fade {
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    .visible {
      opacity: 1;
    }
    .container {
      width: 100%;
      max-width: 500px;
      text-align: center;
    }
    .card {
      background: var(--card);
      border-radius: 1rem;
      padding: 2rem;
      margin: 1rem 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: background 0.3s;
      position: relative;
    }
    .card .icon {
      position: absolute;
      right: 1rem;
      top: 1rem;
      cursor: pointer;
      opacity: 0.7;
    }
    .card .icon:hover {
      opacity: 1;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      border-radius: 1rem;
      overflow: hidden;
      margin: auto;
      max-width: 320px;
    }
    .grid button {
      padding: 1rem;
      border: none;
      background: var(--card);
      color: var(--text);
      white-space: nowrap;
      overflow-wrap: break-word;
      transition: background 0.2s;
    }
    .grid button.correct {
      background: var(--correct);
    }
    .grid button.wrong {
      background: var(--wrong);
    }
    .mode-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }
    .back {
      margin-top: 1rem;
      background: gray;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="mode-toggle" onclick="toggleTheme()">
    <i class="fas fa-adjust"></i>
  </div>
  <div class="container fade visible" id="menu">
    <h2>Select Category</h2>
    <button onclick="startQuiz('NEW')">NEW (<span id="count-NEW">0</span>)</button>
    <button onclick="startQuiz('FAIL')">FAIL (<span id="count-FAIL">0</span>)</button>
    <button onclick="startQuiz('OK')">OK (<span id="count-OK">0</span>)</button>
    <button onclick="startQuiz('GOOD')">GOOD (<span id="count-GOOD">0</span>)</button>
  </div>
  <div class="container fade" id="quiz">
    <div class="card">
      <div id="kanji">単語</div>
      <div id="reading">よみ</div>
      <i class="fas fa-volume-up icon" onclick="playAudio()"></i>
    </div>
    <div class="grid" id="options"></div>
    <button class="back" onclick="showMenu()">&larr; Back</button>
  </div>
  <script>
    const menu = document.getElementById('menu');
    const quiz = document.getElementById('quiz');
    let allWords = [], session = {}, currentWord, mode = 'NEW';

    async function fetchWords() {
      const res = await fetch('vocab.json');
      allWords = await res.json();
      ['NEW','FAIL','OK','GOOD'].forEach(k => session[k] = []);
      allWords.forEach(w => session.NEW.push({...w}));
      updateCounts();
    }

    function updateCounts() {
      ['NEW','FAIL','OK','GOOD'].forEach(k =>
        document.getElementById(`count-${k}`).textContent = session[k].length
      );
    }

    function toggleTheme() {
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? '' : 'dark';
      document.documentElement.setAttribute('data-theme', theme);
    }

    function fadeTo(show, hide) {
      hide.classList.remove('visible');
      show.classList.add('visible');
    }

    function showMenu() {
      fadeTo(menu, quiz);
    }

    function startQuiz(cat) {
      mode = cat;
      fadeTo(quiz, menu);
      nextCard();
    }

    function nextCard() {
      if (session[mode].length === 0) return showMenu();
      const i = Math.floor(Math.random() * session[mode].length);
      currentWord = session[mode].splice(i,1)[0];
      renderCard();
      updateCounts();
    }

    function renderCard() {
      document.getElementById('kanji').textContent = currentWord.japanese;
      document.getElementById('reading').textContent = currentWord.reading || '';
      const grid = document.getElementById('options');
      grid.innerHTML = '';
      let options = allWords.map(w => w.english).sort(() => 0.5 - Math.random()).slice(0,8);
      if (!options.includes(currentWord.english)) options[0] = currentWord.english;
      options = options.sort(() => 0.5 - Math.random());
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.innerHTML = opt.replace(/ ,/g, ',');
        btn.onclick = () => {
          btn.classList.add(opt === currentWord.english ? 'correct' : 'wrong');
          if (opt === currentWord.english) {
            session.GOOD.push(currentWord);
          } else {
            document.querySelectorAll('.grid button').forEach(b => {
              if (b.innerHTML === currentWord.english) b.classList.add('correct');
            });
            session.FAIL.push(currentWord);
          }
          updateCounts();
          setTimeout(nextCard, 1000);
        }
        grid.appendChild(btn);
      });
    }

    async function playAudio() {
      await fetch("https://flashcard-api-cw40.onrender.com/speak", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: currentWord.japanese })
      });
    }

    fetchWords();
  </script>
</body>
</html>
