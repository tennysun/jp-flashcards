<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Japanese Flashcards</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap">
  <style>
    body {
      margin: 0;
      font-family: "Noto Sans JP", sans-serif;
      transition: background 0.4s, color 0.4s;
    }
    body.light {
      background: #f8f8f8;
      color: #111;
    }
    body.dark {
      background: #111;
      color: #f8f8f8;
    }

    .screen {
      display: none;
      padding: 2rem;
      max-width: 700px;
      margin: auto;
    }
    .screen.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    .menu button {
      display: block;
      width: 100%;
      margin: 0.5rem 0;
      padding: 1rem;
      font-size: 1.2rem;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #333;
      color: white;
    }
    body.light .menu button {
      background: #ddd;
      color: #000;
    }

    .toggle {
      position: absolute;
      top: 1rem;
      right: 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      background: #444;
      color: white;
      border: none;
      border-radius: 8px;
    }
    body.light .toggle {
      background: #ccc;
      color: #111;
    }

    .card {
      font-size: 2rem;
      text-align: center;
      padding: 2rem 1rem 0;
    }

    .reading {
      font-size: 1.2rem;
      color: #888;
      margin-top: 0.5rem;
    }

    .speaker-icon {
      width: 1.25rem;
      height: 1.25rem;
      fill: currentColor;
      cursor: pointer;
      opacity: 0.7;
      transition: transform 0.2s ease, opacity 0.2s;
      vertical-align: middle;
      margin-left: 0.5rem;
    }

    .speaker-icon:hover {
      transform: scale(1.2);
      opacity: 1;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      margin-top: 2rem;
      border-radius: 12px;
      overflow: hidden;
    }

    .grid div {
      border: 1px solid #444;
      padding: 1rem;
      word-break: keep-word;
      white-space: pre-wrap;
      cursor: pointer;
    }

    .correct {
      background: #a4f5b1 !important;
      color: black;
    }
    .incorrect {
      background: #ff8c8c !important;
      color: black;
    }

    body.dark .correct {
      background: #4fd57f !important;
      color: black;
    }

    body.dark .incorrect {
      background: #ff5c5c !important;
      color: black;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="dark">
  <button class="toggle" onclick="toggleTheme()">Toggle Theme</button>
  <div id="menu" class="screen menu active"></div>
  <div id="quiz" class="screen" onclick="backgroundClick(event)"></div>

  <script>
    const vocab = JSON.parse(localStorage.getItem("vocab") || `[
      {"japanese":"救う","romaji":"sukuu","furigana":"すくう","meaning":"to save, to rescue"},
      {"japanese":"深い","romaji":"fukai","furigana":"ふかい","meaning":"deep"},
      {"japanese":"期待","romaji":"kitai","furigana":"きたい","meaning":"expectation, hope"},
      {"japanese":"証拠","romaji":"shouko","furigana":"しょうこ","meaning":"evidence, proof"},
      {"japanese":"自信","romaji":"jishin","furigana":"じしん","meaning":"confidence"}
    ]`);
    const progress = JSON.parse(localStorage.getItem("progress") || `{"NEW":[],"FAIL":[],"OK":[],"GOOD":[]}`);
    if (progress.NEW.length === 0) progress.NEW = vocab.map(v => v.japanese);

    let mode = localStorage.getItem("theme") || "dark";
    document.body.className = mode;

    let currentList = [];
    let currentWord = null;
    let session = [];

    function toggleTheme() {
      mode = mode === "dark" ? "light" : "dark";
      document.body.className = mode;
      localStorage.setItem("theme", mode);
    }

    function showMenu() {
      document.getElementById("menu").classList.add("active");
      document.getElementById("quiz").classList.remove("active");

      const m = document.getElementById("menu");
      m.innerHTML = `<h2>Select Category</h2>`;
      ["NEW", "FAIL", "OK", "GOOD"].forEach(type => {
        m.innerHTML += `<button onclick="start('${type}')">${type} (${progress[type].length})</button>`;
      });
    }

    function start(type) {
      currentList = progress[type].slice();
      session = [];
      document.getElementById("menu").classList.remove("active");
      document.getElementById("quiz").classList.add("active");
      pick();
    }

    function pick() {
      if (currentList.length === 0) return showMenu();

      const index = Math.floor(Math.random() * currentList.length);
      const jp = currentList.splice(index, 1)[0];
      currentWord = vocab.find(v => v.japanese === jp);
      session.push(jp);
      render();
    }

    function render() {
      const q = document.getElementById("quiz");
      const correct = currentWord.meaning;
      const choices = [correct];
      while (choices.length < 9) {
        const m = vocab[Math.floor(Math.random() * vocab.length)].meaning;
        if (!choices.includes(m)) choices.push(m);
      }
      const shuffled = choices.sort(() => Math.random() - 0.5);
      q.innerHTML = `
        <div class="card">
          ${currentWord.japanese}
          <svg class="speaker-icon" viewBox="0 0 24 24" onclick="playAudio('${currentWord.japanese}')">
            <path d="M3 10v4h4l5 5V5l-5 5H3z"/>
          </svg>
          <div class="reading">${currentWord.furigana}</div>
        </div>
        <div class="grid">
          ${shuffled.map(m => `<div onclick="answer(this, '${m}', '${correct}')">${m}</div>`).join("")}
        </div>
      `;
    }

    function answer(el, picked, correct) {
      if (el.parentNode.querySelector(".correct")) return;
      const all = el.parentNode.querySelectorAll("div");
      all.forEach(d => {
        if (d.textContent === correct) d.classList.add("correct");
        if (d.textContent === picked && picked !== correct) d.classList.add("incorrect");
      });

      const id = currentWord.japanese;
      const list = progress;
      if (picked === correct) {
        if (list.FAIL.includes(id)) {
          list.FAIL = list.FAIL.filter(x => x !== id);
          if (!list.OK.includes(id)) list.OK.push(id);
        } else if (list.OK.includes(id)) {
          list.OK = list.OK.filter(x => x !== id);
          if (!list.GOOD.includes(id)) list.GOOD.push(id);
        } else {
          list.NEW = list.NEW.filter(x => x !== id);
          if (!list.GOOD.includes(id)) list.GOOD.push(id);
        }
      } else {
        if (!list.FAIL.includes(id)) list.FAIL.push(id);
      }
      localStorage.setItem("progress", JSON.stringify(list));
    }

    function backgroundClick(e) {
      if (!e.target.closest(".grid") && !e.target.closest(".card")) {
        pick();
      }
    }

    async function playAudio(text) {
      try {
        const res = await fetch("https://flashcard-api-cw40.onrender.com/speak", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });
        const blob = await res.blob();
        new Audio(URL.createObjectURL(blob)).play();
      } catch (err) {
        console.error("Audio failed", err);
      }
    }

    showMenu();
  </script>
</body>
</html>