
<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>Flashcard Quiz</title>
<style>
    :root {
      --bg-light: #f5f5f5;
      --bg-dark: #121212;
      --fg-light: #000;
      --fg-dark: #eee;
      --card-light: #fff;
      --card-dark: #1e1e1e;
      --green: #69db7c;
      --red: #ff6b6b;
      --gray-border: rgba(150,150,150,0.25);
    }
    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--bg-light);
      color: var(--fg-light);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--fg-dark);
    }
    #toggle-theme {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.2em;
      background: none;
      border: none;
      cursor: pointer;
      color: inherit;
    }
    #menu, #quiz {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .btn {
      background: var(--card-light);
      color: inherit;
      border-radius: 8px;
      border: 1px solid var(--gray-border);
      padding: 12px 24px;
      cursor: pointer;
      font-size: 1rem;
      width: 200px;
      transition: background 0.2s ease;
    }
    .btn:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    body.dark .btn {
      background: var(--card-dark);
    }
    #card {
      background: var(--card-light);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: background 0.3s;
      cursor: pointer;
    }
    body.dark #card {
      background: var(--card-dark);
    }
    .kanji {
      font-size: 2em;
      font-weight: bold;
    }
    .furigana {
      font-size: 0.8em;
      margin-top: 4px;
    }
    #options-wrapper {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }
    #options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      width: 300px;
    }
    .option {
      aspect-ratio: 1 / 1;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 0.85em;
      line-height: 1.2em;
      white-space: normal;
      word-break: break-word;
      background: var(--card-light);
      border: 1px solid var(--gray-border);
      box-sizing: border-box;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    body.dark .option {
      background: var(--card-dark);
    }
    .option:hover {
      background-color: rgba(0,0,0,0.05);
    }
    .option.correct {
      background-color: var(--green);
      color: #000;
    }
    .option.wrong {
      background-color: var(--red);
      color: #000;
    }
    #feedback {
      font-weight: bold;
    }
    #back {
      margin-top: 12px;
      background: #999;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<button id="toggle-theme">üåì</button>
<div id="menu">
<h1>Select Word Set</h1>
<button class="btn" onclick="startQuiz('NEW')">NEW (<span id="count-new"></span>)</button>
<button class="btn" onclick="startQuiz('FAIL')">FAIL (<span id="count-fail"></span>)</button>
<button class="btn" onclick="startQuiz('OK')">OK (<span id="count-ok"></span>)</button>
<button class="btn" onclick="startQuiz('GOOD')">GOOD (<span id="count-good"></span>)</button>
</div>
<div id="quiz">
<div id="card" onclick="playCurrentAudio()">
<div class="kanji" id="quizKanji"></div>
<div class="furigana" id="quizFurigana"></div>
</div>
<div id="options-wrapper">
<div id="options"></div>
</div>
<div id="feedback"></div>
<button id="back" onclick="returnToMenu()">‚Üê Back</button>
</div>
<script>
let vocabList = [];
let wordStatus = {};
let currentWordList = [];
let currentWord = null;
let hasAnswered = false;

function saveStatus() {
  localStorage.setItem("wordStatus", JSON.stringify(wordStatus));
}
function loadStatus() {
  wordStatus = JSON.parse(localStorage.getItem("wordStatus") || "{}");
}
function updateCounts() {
  const counts = { NEW: 0, FAIL: 0, OK: 0, GOOD: 0 };
  for (const status of Object.values(wordStatus)) {
    counts[status]++;
  }
  document.getElementById("count-new").textContent = counts.NEW;
  document.getElementById("count-fail").textContent = counts.FAIL;
  document.getElementById("count-ok").textContent = counts.OK;
  document.getElementById("count-good").textContent = counts.GOOD;
}
function showMenu() {
  updateCounts();
  document.getElementById("menu").style.display = "flex";
  document.getElementById("quiz").style.display = "none";
}
function startQuiz(mode) {
  currentWordList = vocabList.filter(v => wordStatus[v.japanese] === mode);
  if (currentWordList.length === 0) {
    alert("No words in this category.");
    return;
  }
  document.getElementById("menu").style.display = "none";
  document.getElementById("quiz").style.display = "flex";
  nextCard();
}
function nextCard() {
  if (!currentWordList || currentWordList.length === 0) {
    console.log("‚ö† No words left, returning to menu");
    returnToMenu();
    return;
  }
  currentWord = currentWordList[Math.floor(Math.random() * currentWordList.length)];
  console.log("üìò Showing word:", currentWord.japanese);
  renderCard(currentWord);

  hasAnswered = false;
  document.getElementById("feedback").textContent = "";
  const optionsContainer = document.getElementById("options");
  optionsContainer.innerHTML = "";
  const index = Math.floor(Math.random() * currentWordList.length);
  currentWord = currentWordList[index];
  document.getElementById("quizKanji").textContent = currentWord.japanese;
  document.getElementById("quizFurigana").textContent = currentWord.furigana;

  const wrongChoices = vocabList.filter(v => v.meaning !== currentWord.meaning);
  const allChoices = [...wrongChoices.sort(() => 0.5 - Math.random()).slice(0, 8), currentWord]
                      .sort(() => 0.5 - Math.random());

  allChoices.forEach(choice => {
    const div = document.createElement("div");
    div.className = "option";
    div.textContent = choice.meaning;
    div.onclick = () => {
      if (hasAnswered) return;
      hasAnswered = true;
      if (choice.meaning === currentWord.meaning) {
        div.classList.add("correct");
        wordStatus[currentWord.japanese] =
          wordStatus[currentWord.japanese] === "FAIL" ? "OK" : "GOOD";
      } else {
        div.classList.add("wrong");
        wordStatus[currentWord.japanese] = "FAIL";
        [...optionsContainer.children].forEach(opt => {
          if (opt.textContent === currentWord.meaning) {
            opt.classList.add("correct");
          }
        });
      }
      saveStatus();
      setTimeout(() => {
        document.body.addEventListener("click", waitClickOnce, { once: true });
      }, 100);
    };
    optionsContainer.appendChild(div);
  });
}
function waitClickOnce() {
  nextCard();
}
function returnToMenu() {
  showMenu();
}
function playCurrentAudio() {
  if (!currentWord) return;
  fetch("https://flashcard-api-cw40.onrender.com/speak", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text: currentWord.japanese })
  })
  .then(r => r.blob())
  .then(blob => {
    const url = URL.createObjectURL(blob);
    new Audio(url).play();
  });
}
document.getElementById("toggle-theme").onclick = () => {
  document.body.classList.toggle("dark");
  localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
};

if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark");
}

loadStatus();

fetch("vocab.json")
  .then(res => res.json())
  .then(data => {
    vocabList = data;
    vocabList.forEach(v => {
      if (!wordStatus[v.japanese]) wordStatus[v.japanese] = "NEW";
    });
    showMenu();
  })
  .catch(err => {
    alert("Failed to load vocab.json");
    console.error(err);
  });
</script>
</body>
</html>
